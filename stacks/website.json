{
    "AWSTemplateFormatVersion" : "2010-09-09",
  
    "Description" : "AWS CloudFormation Template para criação de site estáticos contemplando os seguintes componentes: S3, Route53, Cloudfront, Certificate Manager. Este template assume a existência de uma HostedZone já existente no Route53.",
  
    "Parameters" : {
      "HostedZone" : {
        "Type" : "AWS::Route53::HostedZone::Id",
        "Description" : "The DNS name of an existing Amazon Route 53 hosted zone"
      },
      "HostName" : {
        "Type" : "String",
        "Description" : "The hostname that will be appended to HostZone to create the Site",
        "AllowedPattern" : "(?!-)[a-zA-Z0-9-.]{1,63}(?<!-)",
        "ConstraintDescription" : "must be a valid host name."
      },
      "certificateARN" : {
        "Type" : "String",
        "Description" : "The ARN for Valid Public Certificate emited by ACM"
      }
    },
  
    "Mappings" : {
      "Region2S3WebsiteSuffix": {
        "us-east-1"      : { "Suffix": ".s3-website-us-east-1.amazonaws.com" },
        "us-west-1"      : { "Suffix": ".s3-website-us-west-1.amazonaws.com" },
        "us-west-2"      : { "Suffix": ".s3-website-us-west-2.amazonaws.com" },
        "eu-west-1"      : { "Suffix": ".s3-website-eu-west-1.amazonaws.com" },
        "eu-west-2"      : { "Suffix": ".s3-website-eu-west-2.amazonaws.com" },
        "eu-west-3"      : { "Suffix": ".s3-website-eu-west-3.amazonaws.com" },
        "ap-northeast-1" : { "Suffix": ".s3-website-ap-northeast-1.amazonaws.com" },
        "ap-northeast-2" : { "Suffix": ".s3-website-ap-northeast-2.amazonaws.com" },
        "ap-northeast-3" : { "Suffix": ".s3-website-ap-northeast-3.amazonaws.com" },
        "ap-southeast-1" : { "Suffix": ".s3-website-ap-southeast-1.amazonaws.com" },
        "ap-southeast-2" : { "Suffix": ".s3-website-ap-southeast-2.amazonaws.com" },
        "ap-south-1"     : { "Suffix": ".s3-website-ap-south-1.amazonaws.com" },
        "us-east-2"      : { "Suffix": ".s3-website-us-east-2.amazonaws.com" },
        "ca-central-1"   : { "Suffix": ".s3-website-ca-central-1.amazonaws.com" },
        "sa-east-1"      : { "Suffix": ".s3-website-sa-east-1.amazonaws.com" },
        "cn-north-1"     : { "Suffix": ".s3-website.cn-north-1.amazonaws.com.cn" },
        "cn-northwest-1" : { "Suffix": ".s3-website.cn-northwest-1.amazonaws.com.cn" },
        "eu-central-1"   : { "Suffix": ".s3-website-eu-central-1.amazonaws.com" }
      }
  
    },
  
    "Resources" : {
  
      "S3BucketForWebsiteLog" : {
        "Type" : "AWS::S3::Bucket",
        "Properties" : {
          "BucketName" : { "Fn::Join" : [ "", [ "", "logs.", { "Ref" : "HostName" }, ".", { "Ref" : "HostedZone" } ] ] },
          "AccessControl" : "LogDeliveryWrite"
        }
      },
  
      "S3BucketForWebsiteContent" : {
        "Type" : "AWS::S3::Bucket",
        "Properties" : {
          "BucketName" : { "Fn::Join" : [ "", [ "", { "Ref" : "HostName" }, ".", { "Ref" : "HostedZone" } ] ] },
          "AccessControl" : "PublicRead",
          "LoggingConfiguration" : { "DestinationBucketName" : {"Ref" : "S3BucketForWebsiteLog"}, "LogFilePrefix" : "bucket/"},
          "WebsiteConfiguration" : {"IndexDocument" : "index.html", "ErrorDocument" : "error.html"}
        }
      },
  
      "WebsiteCDN" : {
        "Type" : "AWS::CloudFront::Distribution",
        "Properties" : {
           "DistributionConfig" : {
             "Aliases" : [{ "Fn::Join" : [ "", [{ "Ref" : "HostName" }, ".", { "Ref" : "HostedZone" }]]}],
             "PriceClass" : "PriceClass_All",
             "IPV6Enabled" : "true",
             "Comment" : "CDN for S3-backed website",
             "Enabled" : "true",
             "Logging":{"Bucket" : { "Fn::Join" : ["", [{"Ref" : "S3BucketForWebsiteLog"}, ".s3.amazonaws.com"]]}, "IncludeCookies" : "true", "Prefix" : "cdn/"},
              "DefaultCacheBehavior" : {"ForwardedValues" : { "QueryString" : "true" }, "TargetOriginId" : "only-origin", "ViewerProtocolPolicy" : "allow-all"},
              "DefaultRootObject" : "index.html",
              "Origins" : [
                { "CustomOriginConfig" : {"HTTPPort" : "80", "HTTPSPort" : "443", "OriginProtocolPolicy" : "http-only"},
                  "DomainName" : { "Fn::Join" : ["", [{"Ref" : "S3BucketForWebsiteContent"}, {"Fn::FindInMap" : [ "Region2S3WebsiteSuffix", {"Ref" : "AWS::Region"}, "Suffix" ]}]]}, "Id" : "only-origin"}
                  ]
                }
        } 
      },
    
      "WebsiteDNS" : {
        "Type" : "AWS::Route53::RecordSetGroup",
        "Properties" : {
          "HostedZoneName" : { "Fn::Join" : [ "", [{ "Ref" : "HostedZone" }, "."]]},
          "RecordSets" : [{
              "Name" : { "Fn::Join" : [ "", [{ "Ref" : "HostName" }, ".", { "Ref" : "HostedZone" }]]},
              "Type" : "A",
              "AliasTarget" : {
                  "HostedZoneId" : "Z2FDTNDATAQYW2",
                  "DNSName" : { "Fn::GetAtt" : [ "WebsiteCDN", "DomainName" ] }
              }
          },
          {
            "Name" : { "Fn::Join" : [ "", [{ "Ref" : "HostName" }, ".", { "Ref" : "HostedZone" }]]},
            "Type" : "AAAA",
            "AliasTarget" : {
                "HostedZoneId" : "Z2FDTNDATAQYW2",
                "DNSName" : { "Fn::GetAtt" : [ "WebsiteCDN", "DomainName" ] }
            }
          }]
        }
      }
  
    },
  
  
    "Outputs" : {
      "WebsiteURL" : {
        "Value" : { "Fn::Join" : [ "", [{ "Ref" : "HostName" }, ".", { "Ref" : "HostedZone" }]]},
        "Description" : "The URL of the newly created website"
      },
      "DistributionEndpoint" : {
        "Value" : { "Fn::GetAtt" : [ "WebsiteCDN", "DomainName" ] },
        "Description" : "Distribution Endpoint"
      }
    }
  }
  