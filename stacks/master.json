{
    "AWSTemplateFormatVersion" : "2010-09-09",

    "Parameters" : {
        "HostedZone" : {
          "Type" : "AWS::Route53::HostedZone::Id",
          "Description" : "The ID of an existing Amazon Route 53 hosted zone"
        },
        "HostName" : {
          "Type" : "String",
          "Description" : "The HostName address",
          "Default" : "www",
          "AllowedPattern" : "(?!-)[a-zA-Z0-9-.]{1,63}(?<!-)",
          "ConstraintDescription" : "must be a valid host name for url."
        },
        "AlternativeDomains" : {
          "Type" : "String",
          "Description" : "Alternative Domains to be configured in the Certificate"
        },
        "BucketName" : {
            "Type" : "String",
            "Description" : "The S3 address of Stack Resources and Files",
            "Default": "{-INSERT BUCKET NAME WITH STACK TEMPLATES HERE-}"
        }
      },

    "Resources" : {

        "FunctionsStack" : {
            "Type" : "AWS::CloudFormation::Stack",
            "Properties" : {
               "TemplateURL" : { "Fn::Join" : [ "", [ "https://", "s3-", {"Ref" : "AWS::Region"}, ".amazonaws.com/", {"Ref":"BucketName"}, "/stacks/functions.json" ] ] },
	           "Parameters" : {"BucketName" : {"Ref":"BucketName"}},
               "TimeoutInMinutes" : "60"
            }
        },

        "CertificateStack" : {
	       "Type" : "AWS::CloudFormation::Stack",
	       "Properties" : {
                "TemplateURL" : { "Fn::Join" : [ "", [ "https://", "s3-", {"Ref" : "AWS::Region"}, ".amazonaws.com/", {"Ref":"BucketName"}, "/stacks/certificate.json" ] ] },
                "Parameters" : {
                    "HostedZone" : {"Ref":"HostedZone"},
                    "HostName" : {"Ref":"HostName"},
                    "AlternativeDomains" : {"Ref":"AlternativeDomains"},
                    "CertificateRequestLambdaARN" : { "Fn::GetAtt" : [ "FunctionsStack", "Outputs.CertificateRequestFunction" ] },
                    "CertificateApprovalLambdaARN" : { "Fn::GetAtt" : [ "FunctionsStack", "Outputs.CertificateApprovalFunction" ] },
                    "CheckCertificateLambdaARN" : { "Fn::GetAtt" : [ "FunctionsStack", "Outputs.CheckCertificateFunction" ] }
                },
                "TimeoutInMinutes" : "60"
	       }
        },

        "BucketsStack" : {
            "Type" : "AWS::CloudFormation::Stack",
            "Properties" : {
                 "TemplateURL" : { "Fn::Join" : [ "", [ "https://", "s3-", {"Ref" : "AWS::Region"}, ".amazonaws.com/", {"Ref":"BucketName"}, "/stacks/s3buckets.json" ] ] },
                 "Parameters" : {
                     "HostedZone" : {"Ref":"HostedZone"},
                     "HostName" : {"Ref":"HostName"}
                 },
                 "TimeoutInMinutes" : "60"
            }
         },

        "DistributionStack" : {
            "Type" : "AWS::CloudFormation::Stack",
            "Properties" : {
                "TemplateURL" : { "Fn::Join" : [ "", [ "https://", "s3-", {"Ref" : "AWS::Region"}, ".amazonaws.com/", {"Ref":"BucketName"}, "/stacks/distribution.json" ] ] },
                "Parameters" : {
                    "HostedZoneName" : { "Fn::GetAtt" : [ "CertificateStack", "Outputs.HostedZoneName" ] },
                    "HostName" : {"Ref":"HostName"},
                    "HostBucket" : { "Fn::GetAtt" : [ "BucketsStack", "Outputs.SiteBucket" ] },
                    "LogBucket" : { "Fn::GetAtt" : [ "BucketsStack", "Outputs.LogBucket" ] },
                    "certificateARN" : { "Fn::GetAtt" : [ "CertificateStack", "Outputs.CertificateARN" ] }
                },
                "TimeoutInMinutes" : "60"
            }
        }

    },
    "Outputs": {
        "WebsiteURL" : {"Value" : { "Fn::GetAtt" : [ "DistributionStack", "Outputs.WebsiteURL" ] }}
    }
}